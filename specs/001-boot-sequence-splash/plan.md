# Implementation Plan: Boot Sequence — Splash-First, Services Initialization Order

**Branch**: `001-boot-sequence-splash` | **Date**: 2025-10-02 | **Updated**: 2025-10-05 | **Status**: ✅ **COMPLETE**
**Spec**: [spec.md](./spec.md) | **Implementation Status**: [IMPLEMENTATION_STATUS.md](./IMPLEMENTATION_STATUS.md)
**Pull Request**: #8 | **Production Ready**: ✅ Both platforms validated

## Summary

The Boot Sequence feature implements a three-stage initialization system (Stage 0 → Stage 1 → Stage 2) that orchestrates application startup with splash screen feedback, comprehensive diagnostics, service initialization, and failure recovery. The system enforces strict ordering, timeout management, and provides cached-only mode operation when Visual ERP server is unavailable.

**Key Components**: Theme-less splash screen, configuration management, secrets management, structured logging, system diagnostics, data layer initialization, Visual master data caching, core services, localization, theme management, navigation, and comprehensive error handling.

## Technical Context

**Language/Version**: C# .NET 9.0 with nullable reference types enabled
**Primary Dependencies**: Avalonia 11.3+, CommunityToolkit.Mvvm 8.3+, MySQL.Data, HttpClient, Serilog + OpenTelemetry, Polly, AutoMapper, FluentValidation
**Storage**: MySQL 5.7 (MAMP), Visual ERP (read-only via API Toolkit), Local cache (LZ4 compressed), OS-native credential storage
**Testing**: xUnit, FluentAssertions, NSubstitute, Contract + Integration + Unit tests
**Target Platform**: Desktop (Windows via Avalonia), Android (warehouse tablets). Note: macOS and Linux desktop support deferred.
**Project Type**: Mobile + Desktop (Avalonia cross-platform)
**Performance Goals**: Stage 1 <3s, Total boot <10s, Memory <100MB, Network check 5s timeout
**Memory Allocation Budget** (100MB peak during boot):
  - Initial cache population: ~40MB (compressed with LZ4, Parts + Locations + Warehouses + Work Centers)
  - Core services: ~30MB (DI container, logging buffers, connection pools, message bus, validation/mapping)
  - Framework overhead: ~30MB (Avalonia UI, .NET runtime, platform services)
  - Monitoring: Track actual allocation via T161 performance test with memory profiling
**Constraints**: Read-only Visual access (API Toolkit only), Android no direct Visual connection, Offline-capable with cached-only mode
**Scale/Scope**: 160 functional requirements, 13 subsystems, 12+ core services, 23 entities, 4 cached entity types

## Constitution Check ✅ PASS

### I. Cross-Platform First ✅

- Shared boot logic in common libraries, platform-specific code abstracted (splash, credentials), DI for platform services

### II. MVVM Community Toolkit ✅

- [ObservableObject], [ObservableProperty], [RelayCommand], NO ReactiveUI

### III. Test-First Development ✅

- Contract tests for APIs, Integration tests for boot stages, Unit tests for services, TDD workflow enforced

### IV. Theme V2 Semantic Tokens ✅

- Splash theme-less, Post-boot uses Theme V2 dynamic resources, Manufacturing Design System integration

### V. Null Safety ✅

- Nullable types enabled, ArgumentNullException.ThrowIfNull(), error boundaries, offline graceful degradation

### Manufacturing Domain ✅

- Offline-first caching, cached-only mode, role-based MySQL access, barcode detection, retry/circuit breakers

### Development Workflow ✅

- **How-To-Use guide for GitHub Copilot included in Phase 1 deliverables**
- Quickstart guide, troubleshooting catalog, copilot-instructions.md <150 lines

---

## Project Structure

### Documentation (this feature)

```
specs/001-boot-sequence-splash/
├── plan.md              # This file (Phase 0-2 complete)
├── research.md          # Phase 0: Technology decisions (COMPLETE)
├── data-model.md        # Phase 1: Entities and relationships (COMPLETE)
├── quickstart.md        # Phase 1: Executable validation (COMPLETE)
├── how-to-use.md        # Phase 1: GitHub Copilot guide (COMPLETE) ⭐
├── contracts/           # Phase 1: API contracts (directory created)
├── clarify/             # Clarifications (11 files, all resolved)
└── tasks.md             # Phase 2: Generated by /tasks command (COMPLETE - 171 tasks)
```

### Source Code (repository root)

```
MTM_Template_Application/           # Shared Avalonia application
├── Services/
│   ├── Boot/                       # Boot orchestration services
│   ├── Configuration/              # Configuration management
│   ├── Secrets/                    # Credential management (OS-native)
│   ├── Logging/                    # Structured logging (OpenTelemetry)
│   ├── Diagnostics/                # System health checks
│   ├── DataLayer/                  # MySQL, Visual API, HTTP API clients
│   ├── Cache/                      # Visual master data caching
│   ├── Core/                       # Message bus, validation, mapping
│   ├── Localization/               # Culture and language
│   ├── Theme/                      # Theme management
│   └── Navigation/                 # Navigation service
├── ViewModels/
│   └── SplashViewModel.cs          # Splash screen ViewModel
├── Views/
│   └── SplashWindow.axaml          # Splash screen View
└── Models/                         # Entities from data-model.md

MTM_Template_Application.Desktop/   # Desktop entry point
MTM_Template_Application.Android/   # Android entry point

tests/
├── contract/                       # Contract tests (API validation)
├── integration/                    # Integration tests (boot scenarios)
└── unit/                          # Unit tests (service logic)
```

---

## Phase 0: Research ✅ COMPLETE

**Output**: [research.md](./research.md) - Comprehensive technology decisions

All technical unknowns resolved through 11 clarification sessions covering:

- Boot orchestration (3-stage, timeouts, parallelization, watchdog)
- Configuration management (layered precedence, hot-reload, profiles)
- Secrets management (OS-native storage, DPAPI, rotation)
- Logging & telemetry (OpenTelemetry, structured JSON, PII redaction)
- Diagnostics (storage, permissions, network, hardware detection)
- Data layer (connection pooling, circuit breakers, retry policies)
- Core services (message bus, validation, mapping, health checks)
- Visual caching (delta sync, LZ4 compression, TTLs, staleness)
- Localization (language switching, missing translations, fallback)
- Theme management (Light/Dark/Auto, real-time monitoring)
- Navigation (history, deep linking, unsaved changes)
- Visual integration (API whitelist, schema dictionary, auth)
- Cached-only mode (reconnection, feature limitations, banner)
- Splash screen (progress calculation, animation, accessibility)
- Error handling (categorization, recovery, diagnostic bundles)

**Key Decisions**:

- Exponential backoff: 1s, 2s, 4s, 8s, 16s (±25% jitter)
- Circuit breaker: 5 consecutive failures, exponential recovery 30s→10m
- Cache TTL: Parts 24h, Others 7d (configurable)
- Timeouts: Stage 0: 10s, Stage 1: 60s, Stage 2: 15s (configurable)
- Memory budget: 100MB during startup
- Performance targets: Stage 1 <3s, Total <10s

---

## Phase 1: Design & Contracts ✅ COMPLETE

**Output**: data-model.md, how-to-use.md, quickstart.md, contracts/, copilot-instructions.md

### 1. Data Model

[data-model.md](./data-model.md) defines 23 entities organized by subsystem:

- Boot Orchestration: BootMetrics, StageMetrics, ServiceMetrics
- Configuration: ConfigurationProfile, ConfigurationSetting, FeatureFlag
- Secrets: SecretEntry (encrypted credentials)
- Logging: LogEntry (OpenTelemetry format), TelemetryBatch
- Diagnostics: DiagnosticResult, HardwareCapabilities, DiagnosticIssue
- Data Layer: ConnectionPoolMetrics, CircuitBreakerState
- Cache: CacheEntry (LZ4 compressed), CacheStatistics
- Core Services: MessageEnvelope, ValidationRuleMetadata
- Localization: LocalizationSetting, MissingTranslation
- Theme: ThemeConfiguration
- Navigation: NavigationHistoryEntry
- Error Handling: ErrorReport with diagnostic bundles

Each entity includes properties, relationships, validation rules, and state transitions.

### 2. How-To-Use Guide for GitHub Copilot ⭐

[how-to-use.md](./how-to-use.md) - **Comprehensive GitHub Copilot integration guide**:

- Technology stack quick reference (C#, Avalonia, MVVM Toolkit)
- Constitutional patterns (MVVM attributes, null checks, nullable types)
- Architecture patterns (9 detailed patterns with code examples):
  1. Service registration
  2. Boot stage execution
  3. Exponential backoff retry
  4. Circuit breaker
  5. Structured logging (OpenTelemetry)
  6. Configuration management
  7. OS-native secrets storage
  8. Visual master data caching
  9. Splash screen ViewModel
- Testing patterns (unit, integration, TDD workflow)
- Common Copilot prompts for code generation
- Anti-patterns to avoid (ReactiveUI, missing null checks, logging sensitive data)
- File organization reference
- Quick decision tree for service lifetimes, retry strategies, cache TTLs
- Summary checklist for code generation validation

### 3. Quickstart Guide

[quickstart.md](./quickstart.md) - 9 executable validation scenarios:

1. Normal boot sequence (happy path) - all stages, performance validation
2. Configuration loading and override precedence
3. Credential storage and validation (OS-native secure storage)
4. Diagnostic checks and issue detection
5. Visual master data caching (population, hits, staleness, offline mode)
6. Logging and telemetry (structured JSON, filtering, PII redaction, rotation)
7. Error handling and recovery (network, config, circuit breaker, bundles)
8. Accessibility and localization (screen reader, language switching, high contrast)
9. Performance validation (boot time, memory usage, parallel initialization)

Each scenario includes steps, verification checkboxes, success criteria, and PowerShell commands.

### 4. Contracts

[contracts/](./contracts/) directory created - ready for API contract files:

- visual-api-toolkit.yaml (Visual API Toolkit command contracts)
- http-api.yaml (HTTP API contracts for Android)
- diagnostics-api.yaml (System diagnostics contracts)

### 5. Agent Context Update

.github/copilot-instructions.md updated with:

- Language: C# .NET 9.0 with nullable reference types
- Frameworks: Avalonia 11.3+, MVVM Toolkit 8.3+, Serilog, OpenTelemetry, Polly, AutoMapper, FluentValidation
- Databases: MySQL 5.7 (MAMP), Visual ERP (read-only), Local cache (LZ4)
- Recent changes: Boot sequence feature added
- File kept under 150 lines for token efficiency

---

## Phase 2: Task Planning Approach

**This phase will be executed by the `/tasks` command - NOT by `/plan`**

### Task Generation Strategy

The `/tasks` command will:

1. Load `.specify/templates/tasks-template.md` as base template
2. Parse Phase 1 design artifacts (data-model.md, contracts/, quickstart.md)
3. Generate tasks following TDD principles (tests before implementation)
4. Order tasks by dependencies (models → services → UI)
5. Mark independent tasks with [P] for parallel execution

### Task Categories

Based on Phase 1 artifacts, tasks will include:

**Infrastructure (Stage 0):**

- [P] Create boot orchestration interfaces (IBootOrchestrator, IBootStage)
- [P] Implement splash screen ViewModel with MVVM Toolkit
- [P] Create splash screen AXAML view
- [P] Wire up boot progress events

**Core Services (Stage 1):**

- Create configuration service with layered precedence
- Create OS-native secrets service (Windows/Android implementations; macOS deferred)
- Create structured logging service with OpenTelemetry
- [P] Create diagnostics service
- [P] Create validation service
- [P] Create mapping service
- Create data layer clients (MySQL, Visual API Toolkit, HTTP API)
- Create cache service with LZ4 compression and delta sync
- Create message bus with delivery guarantees
- [P] Create localization service
- [P] Create theme service

**Application (Stage 2):**

- Create navigation service with history tracking
- Wire up main application shell
- Implement error handling and recovery

**Testing:**

- Contract tests for Visual API Toolkit commands
- Contract tests for HTTP API endpoints
- Integration tests for boot sequence scenarios (9 from quickstart)
- Unit tests for each service
- Performance tests for boot time and memory targets

### Ordering Strategy

1. **Phase 0: Test Infrastructure** - xUnit setup, test helpers, mocks
2. **Phase 1: Entity Models** - All entities from data-model.md (can be parallel)
3. **Phase 2: Core Services** - Configuration, Secrets, Logging, Diagnostics (sequential for dependencies)
4. **Phase 3: Data Layer** - MySQL, Visual, HTTP clients with retry/circuit breaker
5. **Phase 4: Application Services** - Cache, Message Bus, Validation, Mapping (parallel)
6. **Phase 5: UI Services** - Localization, Theme, Navigation
7. **Phase 6: Boot Orchestration** - Stage execution logic, progress tracking
8. **Phase 7: Splash Screen** - ViewModel and View implementation
9. **Phase 8: Integration** - Wire up all services, end-to-end testing

### Estimated Task Count

- Infrastructure: ~15 tasks
- Entity models: ~23 tasks (from data-model.md)
- Service interfaces: ~16 tasks
- Service implementations: ~59 tasks
- Testing: ~24 tasks (contract + integration + unit tests)
- UI: ~4 tasks
- Platform: ~5 tasks
- Error handling: ~4 tasks
- Unit tests: ~21 tasks
- Polish: ~13 tasks
- **Total: 171 tasks** (final count from tasks.md)

### Parallelization Opportunities

Tasks marked [P] can be executed in parallel:

- Entity model creation (all independent)
- Service interface definition (all independent)
- Unit test creation for different services
- Integration test scenarios (independent scenarios)

---

## Complexity Tracking

**No complexity deviations detected** - Design fully complies with constitutional principles.

---

## Progress Tracking

### Phase Status

- [x] Phase 0: Research complete - research.md created with all technology decisions
- [x] Phase 1: Design complete - data-model.md, how-to-use.md, quickstart.md, contracts/ created
- [x] Phase 2: Tasks planned - tasks.md complete with 171 tasks
- [x] Phase 3: Implementation ready - all prerequisites satisfied
- [ ] Phase 4: Implementation - awaiting task execution
- [ ] Phase 5: Validation - awaiting quickstart.md execution

### Gate Status

- [x] Initial Constitution Check: PASS - Full compliance
- [x] Post-Design Constitution Check: PASS - Maintained compliance
- [x] All clarifications resolved - 11 clarification files covering all unknowns
- [x] Complexity deviations documented - None required

### Artifact Status

- [x] research.md - 17 research areas documented
- [x] data-model.md - 23 entities defined
- [x] how-to-use.md - GitHub Copilot integration guide ⭐
- [x] quickstart.md - 9 validation scenarios
- [x] contracts/ - Directory created
- [x] .github/copilot-instructions.md - Updated (<150 lines)
- [x] tasks.md - Complete with 171 tasks

---

## Next Steps

1. **Review this plan** - Verify completeness and accuracy
2. **Execute `/tasks` command** - Generate tasks.md from Phase 1 artifacts
3. **Execute tasks** - Follow TDD workflow (red-green-refactor)
4. **Run quickstart scenarios** - Validate implementation
5. **Measure performance** - Verify boot time <10s, Stage 1 <3s, memory <100MB

---

*Based on Constitution v1.0.0 - See `.specify/memory/constitution.md`*
*Plan complete. Ready for `/tasks` command execution.*
